import { a as createStaticVNode } from "./app.0d92bd08.js";
import { _ as _export_sfc } from "./plugin-vue_export-helper.21dcd24c.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="stripe\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#stripe\u652F\u4ED8" aria-hidden="true">#</a> stripe\u652F\u4ED8</h1><p>\u524D\u7AEF<code>flutter</code> \u5F8C\u7AEF<code>spring boot</code></p><h2 id="\u524D\u7AEF\u51FA\u767C\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#\u524D\u7AEF\u51FA\u767C\u652F\u4ED8" aria-hidden="true">#</a> \u524D\u7AEF\u51FA\u767C\u652F\u4ED8</h2><div class="language-dart ext-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>paymentMethod <span class="token operator">==</span> <span class="token string">&#39;visa&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//\u4FE1\u7528\u5361\u652F\u4ED8</span>\n    sc<span class="token punctuation">.</span><span class="token function">makeFacilityVisaPayment</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>paymentMethod <span class="token operator">==</span> <span class="token string">&#39;alipay&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//\u652F\u4ED8\u5BF6\u652F\u4ED8</span>\n    sc<span class="token punctuation">.</span><span class="token function">makeFacilityAlipayPayment</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="\u62C6\u5206\u4FE1\u7528\u5361\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#\u62C6\u5206\u4FE1\u7528\u5361\u652F\u4ED8" aria-hidden="true">#</a> \u62C6\u5206\u4FE1\u7528\u5361\u652F\u4ED8</h2><div class="language-dart ext-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">//\u8A2D\u65BD\u4F7F\u7528\u4FE1\u7528\u5361\u652F\u4ED8</span>\n  <span class="token keyword">void</span> <span class="token function">makeFacilityVisaPayment</span><span class="token punctuation">(</span>int id<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      paymentIntentData <span class="token operator">=</span>\n          <span class="token keyword">await</span> <span class="token function">createFacilityPaymentIntent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">&#39;PAY_STRIPE_CARD&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">print</span><span class="token punctuation">(</span>paymentIntentData<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">await</span> <span class="token class-name">Stripe</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">initPaymentSheet</span><span class="token punctuation">(</span>\n        paymentSheetParameters<span class="token punctuation">:</span> <span class="token class-name">SetupPaymentSheetParameters</span><span class="token punctuation">(</span>\n          customFlow<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n          paymentIntentClientSecret<span class="token punctuation">:</span> paymentIntentData<span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">&#39;client_secret&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          applePay<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          googlePay<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          style<span class="token punctuation">:</span> <span class="token class-name">ThemeMode</span><span class="token punctuation">.</span>dark<span class="token punctuation">,</span>\n          merchantCountryCode<span class="token punctuation">:</span> <span class="token string">&#39;HK&#39;</span><span class="token punctuation">,</span>\n          merchantDisplayName<span class="token punctuation">:</span> <span class="token string">&#39;Facility Booking Fee&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">await</span> <span class="token function">displayPaymentSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">await</span> <span class="token function">confirmResultFromServer</span><span class="token punctuation">(</span><span class="token string">&#39;facility&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">on</span> <span class="token class-name">StripeException</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">handleFacilityStripeExecption</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ol><li>\u9810\u652F\u4ED8\u4FE1\u606F\u61C9\u8A72</li></ol><div class="language-dart ext-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">//\u95D6\u5165\u8A2D\u65BDID\uFF0C\u652F\u4ED8\u65B9\u5F0F</span>\n<span class="token function">createFacilityPaymentIntent</span><span class="token punctuation">(</span>int id<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span><span class="token keyword">async</span><span class="token punctuation">{</span>\n    <span class="token comment">//\u4E3B\u8981\u4EE3\u78BC\uFF0Ctry\u6B63\u5E38\u60C5\u6CC1</span>\n    <span class="token keyword">try</span><span class="token punctuation">{</span>\n        <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">await</span> apiService<span class="token punctuation">.</span><span class="token function">requestFacilityPaymentIntent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>\u767C\u9001\u7D66\u865F\u6BB5\u7372\u53D6<code>client_secret</code></li></ol><p>\u8ACB\u6C42\u8DEF\u5F91\uFF1A<code> &quot;/iris-base/api/facility/booking/pay-stripe&quot;</code></p><div class="language-dart ext-dart line-numbers-mode"><pre class="language-dart"><code>  <span class="token comment">//Stripe\u652F\u4ED8\u767C\u9001facility paymentIntent</span>\n  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span> <span class="token function">requestFacilityPaymentIntent</span><span class="token punctuation">(</span>int id<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token class-name">BaseNetWork</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>dio<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Apis</span><span class="token punctuation">.</span>FACILITY_PAY_STRIPE<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;booking_id&#39;</span><span class="token punctuation">:</span> id<span class="token punctuation">,</span> <span class="token string">&#39;pay_type&#39;</span><span class="token punctuation">:</span> channel<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>\u5F8C\u7AEF\u8655\u7406\u524D\u7AEF\u7372\u53D6<code>client_secret</code>\u7684\u8ACB\u6C42</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/booking/pay-stripe&quot;</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@AppLogin</span>\n<span class="token keyword">public</span> <span class="token class-name">UnifyResponseVO</span> <span class="token function">bookingPayStripe</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LoginUid</span> <span class="token class-name">Long</span> uid<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">FacilityBookingPayDTO</span> form<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//\u4E09\u500B\u53C3\u6578\uFF1A\u8A2D\u65BDID\uFF0C\u7528\u6236ID\uFF0C\u652F\u4ED8\u65B9\u5F0F</span>\n    <span class="token class-name">PaymentIntent</span> intent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bookingService<span class="token punctuation">.</span><span class="token function">prepayByStripe</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span><span class="token function">getBookingId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uid<span class="token punctuation">,</span> form<span class="token punctuation">.</span><span class="token function">getPayType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UnifyResponseVO</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StripePaymentIntentResponse</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getClientSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>\u958B\u59CB\u8655\u7406\u652F\u4ED8\u696D\u52D9</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*\u95DC\u806F\u4EE3\u78BC\nprivate final FacilityBookingService bookingService;\n\u5176\u7E7C\u627FPayableService\n*/</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FacilityBookingService</span> <span class="token keyword">extends</span> <span class="token class-name">PayableService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FacilityBooking</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>\n    <span class="token doc-comment comment">/**\n     * stripe \u652F\u4ED8\u4E09\u4EF6\u5957\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">PaymentIntent</span> <span class="token function">prepayByStripe</span><span class="token punctuation">(</span><span class="token class-name">Long</span> parentBookingId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">PayType</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// \u7372\u53D6\u8A72\u8A2D\u65BD\u6240\u6709\u672A\u652F\u4ED8\u7684\u8A2D\u65BD\u5217\u8868</span>\n        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FacilityBooking</span><span class="token punctuation">&gt;</span></span> bookingList <span class="token operator">=</span> bookingRepository<span class="token punctuation">.</span><span class="token function">findByBookingIdAndStatus</span><span class="token punctuation">(</span>parentBookingId<span class="token punctuation">,</span> UNPAID<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// \u7576\u524D\u7528\u6236\u767C\u8D77\u652F\u4ED8\u7684\u8A2D\u65BD\u8A02\u55AE</span>\n        <span class="token class-name">FacilityBooking</span> parentBooking <span class="token operator">=</span> bookingList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentBookingId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token number">4024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// \u5982\u679Cuserid\u5C0D\u61C9\u4E0A\u5C31\u662F\u9019\u500B\u8A02\u55AE\uFF0C\u5426\u5247\u4E0D\u7D66\u652F\u4ED8\uFF0C\u8FD4\u56DE\u670D\u52D9\u932F\u8AA4</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentBooking<span class="token punctuation">.</span><span class="token function">getPayUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServerErrorException</span><span class="token punctuation">(</span><span class="token number">3002</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// \u7372\u53D6\u8A72\u7528\u6236\u4FE1\u606F\uFF0CIrisUser</span>\n        <span class="token class-name">IrisUser</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">userOrException</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// \u8ABF\u7528\u7236\u985E\u65B9\u6CD5</span>\n        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">prepayByStripe</span><span class="token punctuation">(</span>bookingList<span class="token punctuation">,</span> user<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ol start="4"><li>\u8655\u7406\u8A72\u8A2D\u65BD\u7684\u7576\u524D\u8A02\u55AE</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PaymentIntent</span> <span class="token function">prepayByStripe</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> payableList<span class="token punctuation">,</span> <span class="token class-name">IrisUser</span> user<span class="token punctuation">,</span> <span class="token class-name">PayType</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//\u5982\u679CpayableList\u4E2D\u6709\u652F\u4ED8\u4E2D\u7684\u8D26\u5355\u3002</span>\n  <span class="token comment">// \u5982\u679C\u5DF2\u652F\u4ED8\u7684\uFF0C\u5C31\u8981\u5C06\u5DF2\u652F\u4ED8\u7684\u66F4\u6539\u72B6\u6001\uFF0C\u5982\u679C\u672A\u652F\u4ED8\u7684\uFF0C\u5C31\u5C06paymentIntent\u53D6\u6D88\u6389\u3002</span>\n  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> actualPayableList <span class="token operator">=</span> <span class="token function">cancelOldPaymentIntent</span><span class="token punctuation">(</span>payableList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>actualPayableList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">//1. \u8BA1\u7B97\u603B\u4EF7\uFF0C\u5E76\u4E14\u628A\u603B\u4EF7\u8F6C\u6210\u6210\u5206</span>\n        <span class="token class-name">BigDecimal</span> totalPrices <span class="token operator">=</span> actualPayableList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">PayableEntity</span><span class="token operator">::</span><span class="token function">getTotalPrice</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">BigDecimal</span> totalPricesInCents <span class="token operator">=</span> totalPrices<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">,</span> actualPayableList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentRelateType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">PaymentIntent</span> intent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            intent <span class="token operator">=</span> stripeService<span class="token punctuation">.</span><span class="token function">prePay</span><span class="token punctuation">(</span>\n                    totalPricesInCents<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    channel<span class="token punctuation">.</span><span class="token function">convertToStripeChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">StripeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServerErrorException</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">,</span> <span class="token function">simpleMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> item <span class="token operator">:</span> actualPayableList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            item<span class="token punctuation">.</span><span class="token function">prePay</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>actualPayableList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendStripeMessage</span><span class="token punctuation">(</span>actualPayableList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> intent<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="5"><li>\u907F\u514D\u652F\u4ED8\u4E2D\u7684\u8CEC\u55AE\u91CD\u8907\u652F\u4ED8</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">cancelOldPaymentIntent</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> payableList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \u7BE9\u9078\u51FA\u652F\u4ED8\u4E2D\u7684\u8CEC\u55AEpayingPaymentIds</span>\n        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> payingPaymentIds <span class="token operator">=</span> payableList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>PAYING<span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">PayableEntity</span><span class="token operator">::</span><span class="token function">getPaymentId</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paidPaymentIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> paymentId <span class="token operator">:</span> payingPaymentIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                <span class="token class-name">PaymentIntent</span> intent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stripeService<span class="token punctuation">.</span><span class="token function">retrieveOriginalPaymentIntent</span><span class="token punctuation">(</span>paymentId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;succeeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifySuccessFromStripe</span><span class="token punctuation">(</span>paymentId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    paidPaymentIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>paymentId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                    intent<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">StripeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">return</span> payableList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token operator">!</span>paidPaymentIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getPaymentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div>', 19);
function _sfc_render(_ctx, _cache) {
  return _hoisted_1;
}
var stripe___html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render]]);
export { stripe___html as default };
